<include file="Public:header" />
<!-- <if condition="$total_report.add_count gt 0">
	<script src="__PUBLIC__/js/chart/highcharts.js"></script>
	<script src="__PUBLIC__/js/chart/modules/exporting.js"></script>
</if> -->
<style type="text/css">
.pull-left{line-height: 40px;}
</style>
<div class="container">
	<div class="page-header" style="border:none; font-size:14px;">
		<ul class="nav nav-tabs">
			<li class=""><a  href="{:U('order/index')}"><img src="__PUBLIC__/img/caigou.png"/>&nbsp;订单</a></li>
			<li class="active"><a href="{:U('order/analytics')}"><img src="__PUBLIC__/img/tongji.png"/> &nbsp;统计</a></li>
		</ul>
	</div>
	<include file="Public:alert" />
	<div class="row">
		<div class="span12">
			<ul class="nav pull-left">
				<li class="pull-left">
					<form class="form-inline" id="searchForm" onsubmit="return checkSearchForm();" action="" method="get">
						<ul class="nav pull-left">
							<if condition="$Think.session.position_id eq '13' ">
								<li class="pull-left">
									选择特许经营商
									&nbsp; <select style="width:auto" name="areaAllAgent" onchange="onAreaAllAgent();" id="areaAllAgent">
									<option class="" value="all">全部</option>
									<volist name="areaAllAgent" id="vo">
										<option value="{$vo.user_id}">{$vo.name}</option>
										<!-- <option value="{$vo.user_id}" <eq name="vo['user_id']" value="$areaAllAgentSelect" >selected</eq> >{$vo.name}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									选择企业管家
									&nbsp; <select style="width:auto" class = "tradeagent" name="tradeagent" onchange="ontradeagent();" id="tradeagent">
									<option class="all" value="all">全部</option>
									<volist name="tradeagent" id="vo">
										<option value="{$vo.user_id}">{$vo.name}</option>
										<!-- <option value="{$vo.user_id}" <eq name="vo.user_id" value="$tradeagentSelect" >selected</eq> >{$vo.name}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									选择社区店铺区域
									&nbsp; <select style="width:auto" name="shopsagent" onchange="onshopsagent();" id="shopsagent">
									<option class="all" value="all">全部</option>
									<volist name="shopsagent" id="vo">
										<option value="{$vo.user_id}">{$vo.name}</option>
										<!-- <option value="{$vo.user_id}" <eq name="vo.user_id" value="$shopsagentSelect" >selected</eq> >{$vo.name}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>

								<li class="pull-left">
									<!-- 选择公司&nbsp; <select style="width:auto" name="company" id="company" onchange="onchangecompany();"> -->
									选择公司&nbsp; <select style="width:auto" name="company" id="company">
									<option class="all" value="all">全部</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
							</if>
							<if condition="$Think.session.position_id eq '14'">
								<li class="pull-left">
									选择特许经营商
									&nbsp; <select style="width:auto" name="areaAllAgent">
									<option class="" value="{:session('user_id')}"><?php echo session('name')?></option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									选择企业管家
									&nbsp; <select style="width:auto" class = "tradeagent" name="tradeagent" onchange="ontradeagent();" id="tradeagent">
									<option class="all" value="all">全部</option>
									<volist name="tradeagent" id="vo">
										<option value="{$vo.user_id}">{$vo.name}</option>
										<!-- <option value="{$vo.user_id}" <eq name="vo.user_id" value="$tradeagentSelect" >selected</eq> >{$vo.name}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									选择社区店铺区域
									&nbsp; <select style="width:auto" name="shopsagent" onchange="onshopsagent();" id="shopsagent">
									<option class="all" value="all">全部</option>
									<volist name="shopsagent" id="vo">
										<option value="{$vo.user_id}">{$vo.name}</option>
										<!-- <option value="{$vo.user_id}" <eq name="vo.user_id" value="$shopsagentSelect" >selected</eq> >{$vo.name}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>

								<li class="pull-left">
									<!-- 选择公司&nbsp; <select style="width:auto" name="company" id="company" onchange="onchangecompany();"> -->
									选择公司&nbsp; <select style="width:auto" name="company" id="company">
									<option class="all" value="all">全部</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
<!-- 								<li class="pull-left">
									选择员工&nbsp; <select style="width:auto" name="role" id="companyuser">
									<option class="all" value="all">{:L('ALL')}</option>
								</select>&nbsp;&nbsp;
								</li> -->
							</if>
							<if condition="$Think.session.position_id eq '15' ">
								<li class="pull-left">
									特许经营商&nbsp; <select style="width:auto" name="tradeagent" onchange="" id="">
									<option class="" value="all1">{$gAgent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									企业管家&nbsp; <select style="width:auto" name="shopsagent" onchange="" id="">
									<option class="all" value="{:session('user_id')}"><?php echo session('name');?></option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>

								<li class="pull-left">
									<!-- 公司&nbsp; <select style="width:auto" name="company" onchange="onchangecompany();" id="company" > -->
									公司&nbsp; <select style="width:auto" name="company" id="company" >
									<option class="all" value="all">{:L('ALL')}</option>
									<volist name="company" id="vo">
										<option class="" value="{$vo.user_id}">{$vo.company}</option>
										<!-- <option class="" value="{$vo.user_id}" <eq name="vo.user_id" value="$companySelect" >selected</eq> >{$vo.company}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
<!-- 								<li class="pull-left">
									员工&nbsp; <select style="width:auto" name="role" id="companyuser">
									<option class="all" value="all">{:L('ALL')}</option>
								</select>&nbsp;&nbsp;
								</li> -->
							</if>
							<if condition=" $Think.session.position_id eq '16' ">
								<li class="pull-left">
									区域总代理
									&nbsp; <select style="width:auto" name="tradeagent" onchange="" id="">
									<option class="" value="all1">{$gAgent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									社区店铺区域
									&nbsp; <select style="width:auto" name="shopsagent" id="shopsagent">
									<option class="" value="all1">{$shopagent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>

								<li class="pull-left">
									<!-- 选择公司&nbsp; <select style="width:auto" name="company" id="company" onchange="onchangecompany();"> -->
									选择公司&nbsp; <select style="width:auto" name="company" id="company">
									<option class="all" value="all">{:L('ALL')}</option>
									<volist name="company" id="vo">
										<option class="" value="{$vo.user_id}">{$vo.company}</option>
										<!-- <option class="" value="{$vo.user_id}" <eq name="vo.user_id" value="$companySelect" >selected</eq> >{$vo.company}</option> -->
									</volist>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
<!-- 								<li class="pull-left">
									选择员工&nbsp; <select style="width:auto" name="role" id="companyuser">
									<option class="all" value="all">{:L('ALL')}</option>
								</select>&nbsp;&nbsp;
								</li> -->
							</if>
							<if condition=" $Think.session.position_id eq '19' OR $Think.session.position_id eq '20' ">
								<li class="pull-left">
									区域总代理
									&nbsp; <select style="width:auto" name="tradeagent" onchange="" id="">
									<option class="" value="all1">{$gAgent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									社区店铺区域
									&nbsp; <select style="width:auto" name="shopsagent" id="shopsagent">
									<option class="" value="all1">{$shopagent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>

								<li class="pull-left">
									<!-- 选择公司&nbsp; <select style="width:auto" name="company" id="company" onchange="onchangecompany();"> -->
									选择公司&nbsp; <select style="width:auto" name="company" id="company">
									<option class="all" value="all1"><?php echo session('company');?></option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
<!-- 								<li class="pull-left">
									选择员工&nbsp; <select style="width:auto" name="role" id="companyuser">
									<option class="all" value="all">{:L('ALL')}</option>
									<volist name="roleList" id="vo">
										<option value="{$vo.role_id}">{$vo.user_name}</option>
									</volist>
								</select>&nbsp;&nbsp;
								</li> -->
							</if>
							<if condition="$Think.session.position_id eq 17 OR $Think.session.position_id eq 18">
								<li class="pull-left">
									特许经营商&nbsp; <select style="width:auto" name="tradeagent" onchange="" id="">
									<option class="" value="all1">{$gAgent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									企业管家&nbsp; <select style="width:auto" name="shopsagent" onchange="" id="">
									<option class="all" value="all1">{$shopagent}</option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
								<li class="pull-left">
									公司&nbsp; <select style="width:auto" name="company" id="" onchange="">
									<option class="all" value="all1"><?php echo session('company')?></option>
								</select>&nbsp;&nbsp;&nbsp;
								</li>
<!-- 								<li class="pull-left">
									员工:&nbsp; <select style="width:auto" name="role" id="role" onchange="changeCondition()">
									<option class="all" value="all">{:L('ALL')}</option>
									<volist name="roleList" id="vo">
										<option value="{$vo.role_id}">{$vo.user_name}</option>
									</volist>
								</select>&nbsp;&nbsp;
								</li> -->
							</if>
							<br/>
							<li class="pull-left">
								选择日期:&nbsp; 从<input type="text" id="start_time" name="start_time" onClick="WdatePicker({dateFmt:'yyyy-MM-dd'})" class="Wdate" value="{$Think.get.start_time}"/>至<input type="text" id="end_time" onClick="WdatePicker({dateFmt:'yyyy-MM-dd'})" name="end_time" class="Wdate" value="{$Think.get.end_time}" />&nbsp;&nbsp;
							</li>
							<li class="pull-left"><input type="hidden" name="m" value="order"/><input type="hidden" name="a" value="analytics"/>
								<if condition="$Think.get.by neq null"><input type="hidden" name="by" value="{$Think.get.by}"/></if>
								<button type="submit" class="btn">{:L('SEARCH')}</button></li>
						</ul>
					</form>
				</li>
			</ul>
		</div>
		<div class="span2 knowledgecate">
			<ul class="nav nav-list">
				<li class="active">
					<a href="javascript:void(0);">订单统计表</a>
				</li>
			</ul>
		</div>
		<div class="span10">
			<div id="report_content">
				<table class="table table-hover table-striped" id="mytable">
					<thead>
					<tr>
						<th>特许经营商</th>
						<th>企业管家/社区店铺区域</th>
						<th>公司</th>
						<th>订单总数</th>
						<th>已完成订单数</th>
						<th>已完成订单销售额</th>
					</tr>
					</thead>
					<tfoot>
					<tr style="background:yellow" id="totalRow">
					</tr>
					<tr><img src="__PUBLIC__/img/u130.png" alt="">代表社区区域代理</tr>
					</tfoot>
					<tbody>
					<volist name="reportList" id="vo">
						<tr>
							<if condition="$Think.session.position_id eq '14'">
								<td><?php echo session('name');?></td>
								<td>{:getAreaAgent($vo['user'])['name']}</td>
							<else/>
								<td>{:getGenerAgent($vo['user'])['name']}</td>
								<td>{:getAreaAgent($vo['user'])['name']}</td>
							</if>
							<td><?php if($vo['user']['position_id'] == 16){echo "<img src='__PUBLIC__/img/u130.png'>";};?>{$vo.user.company}</td>
							<td>{$vo.ordernum.orderTotalNum}</td>
							<td>{$vo.ordernum.orderFinishNum}</td>
							<td>{$vo.ordernum.orderFinishMoney}</td>
						</tr>
					</volist>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<div class="hide" id="dialog-role-info" title="{:L('EMPLOYEE_INFORMATION')}">loading...</div>
<script type="text/javascript">
	function onAreaAllAgent(){
		var user_id = $('#areaAllAgent').val();
		if(user_id == 'all'){
			window.location.reload();;
		}else{			
			$.ajax({
				type:'get',
				url:'index.php?m=order&a=getcompany&userId='+user_id,
				async:true,
				success:function(data){
					options = '';
					options = '<option class="all" value="all">{:L('ALL')}</option>';
					if(data.data.shopsagent){
						$.each(data.data.shopsagent, function(k, v){
							options += '<option value="'+v.user_id+'">'+v.name+'</option>';
						});
					}
					options1 = '';
					options1 = '<option class="all" value="all">{:L('ALL')}</option>';
					if(data.data.tradeagent){
						$.each(data.data.tradeagent, function(k, v){
							options1 += '<option value="'+v.user_id+'">'+v.name+'</option>';
						});
					}
					$("#tradeagent").html(options1);
					$("#shopsagent").html(options);
				},
				dataType:'json'
			});
		}
	}

	function ontradeagent(){
		var user_id = $('#tradeagent').val();
		if(user_id == ''){
			$("#company").html('');
		}else{
			$("#shopsagent").val('全部');
			$.ajax({
				type:'get',
				url:'index.php?m=finance&a=getcompany&userId='+user_id,
				async:true,
				success:function(data){
					options = '';
					options = '<option class="all" value="all">{:L('ALL')}</option>';
					if(data.data){
						$.each(data.data, function(k, v){
							options += '<option value="'+v.user_id+'">'+v.company+'</option>';
						});
					}
					$("#company").html(options);
				},
				dataType:'json'
			});
		}
	}

	function onshopsagent(){
		var user_id = $('#shopsagent').val();
		if(user_id == ''){
			$("#company").html('');
		}else{
			$("#tradeagent").val('全部');
			$.ajax({
				type:'get',
				url:'index.php?m=finance&a=getcompany&userId='+user_id,
				async:true,
				success:function(data){
					options = '';
					options = '<option class="all" value="all">{:L('ALL')}</option>';
					if(data.data){
						$.each(data.data, function(k, v){
							options += '<option value="'+v.user_id+'">'+v.company+'</option>';
						});
					}
					$("#company").html(options);
				},
				dataType:'json'
			});
		}
	}

	$(document).ready(function() {
		var TotalNum = 0;
		var FinishNum = 0;
		var FinishMoney = 0;
		$('#mytable tr').each(function() {
			$(this).find('td:eq(3)').each(function(){
				TotalNum += parseFloat($(this).text());
			});
			$(this).find('td:eq(4)').each(function(){
				FinishNum += parseFloat($(this).text());
			});
			$(this).find('td:eq(5)').each(function(){
				FinishMoney += parseFloat($(this).text());
			});
		});

		$('#totalRow').append('<td></td><td></td><td>共计</td><td><span style="color:red;">'+TotalNum+'</span></td><td><span style="color:red;">'+FinishNum+'</span></td><td><span style="color:red;">'+FinishMoney.toFixed(2)+'</span></td>');
	});

// $(document).ready(function() {
// 	var _company = "{$companySelect}",
// 		_companyName = "{$companyName}";
// 	if(_company != 'all'){
// 		_options = '<option class="all" value="'+_company+'">'+_companyName+'</option>';
// 		$("#company").html(_options);
// 	}
// })
</script>
<include file="Public:footer" />